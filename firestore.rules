rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para la colección 'users'
    match /users/{userId} {
      // Cualquiera puede crear su propio perfil de usuario al registrarse
      allow create: if request.auth != null;
      // Solo el propio usuario puede leer y actualizar sus datos
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // Nadie puede eliminar perfiles de usuario directamente desde el cliente
      allow delete: if false; 
    }

    // Reglas para colecciones de configuración como 'ot-categories', 'services', etc.
    // Generalmente, estas son de solo lectura para los clientes.
    match /ot-categories/{categoryId} {
      allow read: if request.auth != null;
      allow write: if false; // La escritura se gestiona desde el backend con credenciales de admin
    }
    
    match /ot-statuses/{statusId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /services/{serviceId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /suggested-tasks/{taskId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /report-templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if false; 
    }

    // Los informes enviados pueden ser creados por cualquier usuario autenticado,
    // pero solo leídos por roles autorizados (se asume que la lógica de la app lo controla).
    match /submitted-reports/{reportId} {
        allow create, read: if request.auth != null;
        allow update, delete: if false; // La edición/eliminación debería ser restringida
    }

    // Colecciones principales de datos
    match /work-orders/{orderId} {
      allow read, create, update: if request.auth != null;
      allow delete: if false; // Proteger contra borrados accidentales
    }

    match /collaborators/{collaboratorId} {
      allow read, create, update: if request.auth != null;
      allow delete: if request.auth != null; // O restringir a roles específicos
    }

    match /vehicles/{vehicleId} {
      allow read, create, update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /gantt-charts/{chartId} {
       allow read, create, update: if request.auth != null;
       allow delete: if request.auth != null;
    }
    
    // Acceso a la configuración de la empresa
    match /settings/companyInfo {
      allow read: if request.auth != null;
      allow write: if false; // Solo se modifica desde el backend
    }
  }
}